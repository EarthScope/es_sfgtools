[workspace]
name = "es_sfgtools"
channels = ["conda-forge"]
platforms = ["win-64", "linux-64", "osx-64", "osx-arm64"]

# =============================================================================
# Tasks
# =============================================================================
[tasks]
test = "pytest tests/"
test-garpos = "pytest tests/test_garpos.py -v"
test-garpos-install = "pytest tests/test_garpos.py::TestGarposInstallation -v"
lint = "black --check src/"
format = "black src/"
docs = { cmd = "make html", cwd = "docs" }
build-go = { cmd = "make -B", cwd = "src/golangtools" }

# Clone and install garpos from source
clone-garpos = "git clone https://github.com/s-watanabe-jhod/garpos.git external/garpos || (cd external/garpos && git pull)"
compile-garpos = {cmd = "gfortran -shared -fPIC -fopenmp -O3 -o lib_raytrace.so sub_raytrace.f90 lib_raytrace.f90",cwd = "external/garpos/bin/garpos_v102/f90lib", depends-on = ["clone-garpos"]}

# Clone and install PRIDE-PPPAR
clone-pride = { cmd = "git clone --depth 1 https://github.com/PrideLab/PRIDE-PPPAR.git  || git pull || echo Skipping clone ",cwd = "external/"}
install-pride = { cmd = "chmod +x install.sh && echo 'N' | HOME=$PIXI_PROJECT_ROOT/external ./install.sh", cwd = "external/PRIDE-PPPAR", depends-on = ["clone-pride"] }

# =============================================================================
# Conda dependencies (things that need to come from conda-forge)
# =============================================================================
[dependencies]
python = ">=3.11"
pip = ">=24.0"
uv = "*"

# Core conda dependencies (native libs / better binary compat)
numpy = ">=1.23.5,<2"
proj = "*"
scikit-sparse = "*"
tiledb = "2.30.*"
tiledb-py = "*"
scikit-learn = ">=1.7"
pyarrow = "*"

# Build / compiler dependencies
setuptools = ">=62.6"
setuptools_scm = ">=6.2"
wheel = "*"
clang = "*"
gfortran = "*"
go = ">=1.22"
go-cgo = "*"
make = "*"
requests = ">=2.32.5,<3"
pytest = ">=9.0.2,<10"

# =============================================================================
# Platform-specific conda dependencies
# =============================================================================
[target.linux-64.dependencies]
bc = "1.07.*"
sqlite = ">=3.49"
gcc = ">=15"
libstdcxx-ng = ">=15"
nodejs = ">=24"

# =============================================================================
# PyPI dependencies - install this package in editable mode
# This pulls in all dependencies from pyproject.toml [project.dependencies]
# =============================================================================
[pypi-dependencies]
es_sfgtools = { path = ".", editable = true }

# =============================================================================
# Feature: dev (adds dev tools)
# =============================================================================
[feature.dev.dependencies]
black = "*"

[feature.dev.pypi-dependencies]
# Optional dev deps from pyproject.toml are installed via editable install
# Add any extra dev-only PyPI packages here if needed

# =============================================================================
# Feature: notebook (adds Jupyter support)
# =============================================================================
[feature.notebook.dependencies]
ipykernel = "*"
jupyterlab = "*"

# =============================================================================
# Environments
# =============================================================================
[environments]
default = { solve-group = "default" }
dev = { features = ["dev"], solve-group = "default" }
notebook = { features = ["notebook"], solve-group = "default" }
full = { features = ["dev", "notebook"], solve-group = "default" }

# =============================================================================
# Activation - environment variables
# =============================================================================
[activation]
env = { CGO_ENABLED = "1", PIP_INDEX_URL = "https://pypi.org/simple", GARPOS_PATH = "$PIXI_PROJECT_ROOT/external/garpos", PATH = "$PIXI_PROJECT_ROOT/external/.PRIDE_PPPAR_BIN:$PATH" }

[target.osx-64.activation]
env = { DYLD_LIBRARY_PATH = "$PIXI_PROJECT_ROOT/.pixi/envs/$PIXI_ENVIRONMENT_NAME/lib:$DYLD_LIBRARY_PATH" }

[target.osx-arm64.activation]
env = { DYLD_LIBRARY_PATH = "$PIXI_PROJECT_ROOT/.pixi/envs/$PIXI_ENVIRONMENT_NAME/lib:$DYLD_LIBRARY_PATH" }

[target.linux-64.activation]
env = { LD_LIBRARY_PATH = "$PIXI_PROJECT_ROOT/.pixi/envs/$PIXI_ENVIRONMENT_NAME/lib:$LD_LIBRARY_PATH" }

[target.win-64.activation]
env = { PATH = "$PIXI_PROJECT_ROOT/.pixi/envs/$PIXI_ENVIRONMENT_NAME/Library/bin;$PATH" }
