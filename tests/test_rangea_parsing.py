import tempfile
import json
from pathlib import Path
from es_sfgtools.novatel_tools import deserialize_rangea, GNSSEpoch
from es_sfgtools.tiledb_tools.tiledb_schemas import TDBGNSSObsArray
from es_sfgtools.tiledb_tools.tiledb_operations import tile2rinex

fake_rinex_settings = {
    "rinex_version": "2.11",
    "rinex_type": "O",
    "rinex_system": "G",
    "marker_name": "NTH1",
    "marker_number": "0001",
    "markerType": "GEODETIC",
    "observer": "EarthScope",
    "agency": "EarthScope",
    "program": "gnsstools",
    "run_by": "",
    "date": "",
    "receiver_model": "NOV",
    "receiver_serial": "XXXXXXXXXX",
    "receiver_firmware": "0.0.0",
    "antenna_model": "TRM59800.00 SCIT",
    "antenna_serial": "987654321",
    "antenna_position": [0, 0, 0],
    "antenna_offsetHEN": [0, 0, 0],
}

rangea = [
    "#RANGEA,USB2,0,73.5,FINESTEERING,2379,414835.000,02000000,5103,17136;29,10,0,21226572.227,0.088,-111546445.541361,0.011,-1044.146,51.5,15479.375,1810dc04,10,0,21226580.909,0.027,-86919367.542363,0.013,-813.621,51.9,15479.375,11305c0b,2,0,22487273.396,0.127,-118171420.798977,0.011,2413.754,48.3,1539.711,0810dc24,2,0,22487278.552,0.065,-92081649.948892,0.014,1880.850,44.0,1539.711,01305c2b,27,0,22817538.937,0.146,-119906970.846230,0.017,-2971.176,47.0,121.873,0810dc44,27,0,22817550.554,0.062,-93434050.612936,0.023,-2315.206,44.4,121.873,01305c4b,28,0,24119951.363,0.257,-126751247.225666,0.017,3360.020,42.1,1529.745,1810dc64,28,0,24119964.327,0.147,-98767296.354503,0.027,2618.211,37.0,1529.745,11305c6b,1,0,24712422.445,0.304,-129864650.423649,0.023,3412.945,40.7,219.796,1810dca4,1,0,24712431.734,0.150,-101193272.766201,0.048,2659.458,36.8,219.796,11305cab,32,0,20566515.098,0.069,-108077894.420914,0.010,115.470,53.6,9469.066,1810dcc4,32,0,20566523.461,0.021,-84216644.183456,0.012,89.977,53.7,9469.066,11305ccb,8,0,22217890.975,0.138,-116755788.916407,0.014,-1295.460,47.5,1537.906,0810dce4,8,0,22217901.735,0.059,-90978576.748969,0.017,-1009.451,44.9,1537.906,01305ceb,24,0,24185409.041,0.391,-127095180.329100,0.042,-2124.549,38.5,156.018,1810dd04,24,0,24185419.950,0.134,-99035248.371074,0.056,-1655.484,37.8,156.018,11305d0b,23,0,23482052.492,0.214,-123399012.293142,0.015,-2615.146,43.7,19269.080,1810dd44,23,0,23482061.134,0.109,-96155096.197117,0.025,-2037.782,39.6,19269.080,11305d4b,194,0,42992233.529,0.397,-225925710.104074,0.025,-86.325,40.1,120.076,0815de04,194,0,42992245.764,0.220,-176046055.806780,0.034,-67.269,43.5,120.076,0235de0b,43,3,19391198.435,1.273,-103475166.025578,0.067,-329.467,38.8,8.434,08019704,44,12,21189277.278,0.118,-113427866.417973,0.007,2695.678,42.7,622.767,08119f24,44,12,21189288.039,0.021,-88221723.977960,0.014,2096.642,41.9,622.767,00b13f2b,59,4,21451385.146,0.128,-114508955.303281,0.010,3479.152,42.0,1642.590,18119f44,59,4,21451394.918,0.021,-89062566.489244,0.013,2706.009,42.1,1642.590,10b13f4b,58,11,19250057.364,0.091,-103010970.385460,0.010,-688.580,45.0,10914.840,08119fc4,58,11,19250066.032,0.016,-80119688.020126,0.012,-535.563,44.2,10809.520,00b13fcb,42,8,22457286.513,0.155,-120047047.161290,0.011,-3661.965,40.3,1537.458,18119c04,42,8,22457296.817,0.029,-93369962.177385,0.019,-2848.199,39.4,1537.458,00b13c0b*85f7e08f",
    "#RANGEA,USB2,0,73.0,FINESTEERING,2379,414837.400,02000000,5103,17136;29,10,0,21227047.960,0.099,-111548945.507366,0.009,-1041.010,50.4,15481.775,1810dc04,10,0,21227056.640,0.036,-86921315.562892,0.012,-811.178,49.2,15481.775,11305c0b,2,0,22486171.452,0.145,-118165630.074757,0.012,2410.989,47.1,1542.111,0810dc24,2,0,22486176.614,0.062,-92077137.671857,0.018,1878.689,44.5,1542.111,01305c2b,27,0,22818895.223,0.150,-119914098.080315,0.123,-2970.819,46.8,124.273,0810dc44,27,0,22818906.825,0.045,-93439604.289166,0.125,-2314.928,47.2,124.273,01305c4b,28,0,24118415.119,0.265,-126743174.265265,0.016,3365.434,41.9,1532.145,1810dc64,28,0,24118428.044,0.106,-98761005.739597,0.028,2622.425,39.8,1532.145,11305c6b,1,0,24710865.298,0.352,-129856467.755949,0.019,3407.313,39.4,222.196,1810dca4,1,0,24710874.620,0.125,-101186896.561685,0.056,2655.040,38.4,222.196,11305cab,32,0,20566460.931,0.059,-108077609.757425,0.007,118.325,54.9,9471.466,1810dcc4,32,0,20566469.298,0.019,-84216422.371495,0.010,92.202,54.7,9471.466,11305ccb,8,0,22218482.788,0.157,-116758898.905521,0.013,-1298.268,46.4,1540.306,0810dce4,8,0,22218493.565,0.048,-90981000.128073,0.018,-1011.638,46.8,1540.306,01305ceb,24,0,24186379.802,0.393,-127100281.566008,0.031,-2125.109,38.5,158.418,1810dd04,24,0,24186390.696,0.113,-99039223.337696,0.045,-1655.931,39.3,158.418,11305d0b,23,0,23483245.895,0.257,-123405283.467522,0.016,-2611.419,42.1,19271.479,1810dd44,23,0,23483254.524,0.097,-96159982.836505,0.026,-2034.872,40.6,19271.479,11305d4b,194,0,42992274.509,0.472,-225925925.235678,0.050,-91.948,40.5,122.476,0815de04,194,0,42992286.715,0.185,-176046223.433838,0.058,-71.650,44.9,122.476,0235de0b,43,3,19391345.220,0.745,-103475951.576682,0.115,-332.436,37.6,10.834,08019704,44,12,21188068.501,0.157,-113421395.866903,0.009,2694.527,40.2,625.167,08119f24,44,12,21188079.285,0.022,-88216691.328353,0.014,2095.746,41.5,625.167,00b13f2b,59,4,21449821.638,0.149,-114500609.184536,0.010,3475.397,40.7,1644.990,18119f44,59,4,21449831.400,0.022,-89056075.066605,0.013,2703.088,41.8,1644.990,10b13f4b,58,11,19250364.851,0.102,-103012615.838062,0.009,-686.416,44.0,10917.240,08119fc4,58,11,19250373.524,0.016,-80120967.807524,0.013,-533.881,44.2,10811.920,00b13fcb,42,8,22458930.384,0.183,-120055834.661669,0.011,-3660.766,38.9,1539.858,18119c04,42,8,22458940.717,0.025,-93376796.889062,0.019,-2847.268,40.5,1539.858,00b13c0b*f00dc51e",
    "#RANGEA,USB2,0,73.0,FINESTEERING,2379,414837.600,02000000,5103,17136;29,10,0,21227087.610,0.100,-111549153.861782,0.010,-1042.124,50.3,15481.976,1810dc04,10,0,21227096.289,0.034,-86921477.916948,0.012,-812.046,49.8,15481.976,11305c0b,2,0,22486079.734,0.133,-118165148.093229,0.012,2409.376,47.9,1542.311,0810dc24,2,0,22486084.897,0.063,-92076762.100511,0.017,1877.433,44.3,1542.311,01305c2b,27,0,22819008.323,0.146,-119914692.423340,0.111,-2972.127,47.0,124.473,0810dc44,27,0,22819019.927,0.050,-93440067.412944,0.125,-2315.948,46.4,124.473,01305c4b,28,0,24118287.055,0.231,-126742501.288071,0.015,3364.731,43.1,1532.345,1810dc64,28,0,24118299.976,0.093,-98760481.344559,0.028,2621.878,41.0,1532.345,11305c6b,1,0,24710735.629,0.367,-129855786.353830,0.019,3406.803,39.0,222.396,1810dca4,1,0,24710744.951,0.123,-101186365.594648,0.055,2654.641,38.5,222.396,11305cab,32,0,20566456.463,0.061,-108077586.274714,0.007,116.761,54.7,9471.666,1810dcc4,32,0,20566464.829,0.019,-84216404.074342,0.010,90.984,54.7,9471.666,11305ccb,8,0,22218532.231,0.144,-116759158.728466,0.014,-1299.940,47.2,1540.506,0810dce4,8,0,22218543.009,0.044,-90981202.584522,0.018,-1012.942,47.6,1540.506,01305ceb,24,0,24186460.686,0.377,-127100706.603071,0.029,-2124.947,38.8,158.618,1810dd04,24,0,24186471.574,0.113,-99039554.527382,0.045,-1655.804,39.3,158.618,11305d0b,23,0,23483345.279,0.254,-123405805.717144,0.015,-2611.177,42.3,19271.680,1810dd44,23,0,23483353.909,0.091,-96160389.784551,0.026,-2034.684,41.2,19271.680,11305d4b,194,0,42992278.026,0.494,-225925943.723080,0.048,-92.765,39.4,122.676,0815de04,194,0,42992290.233,0.204,-176046237.838398,0.058,-72.287,44.1,122.676,0235de0b,43,3,19391357.685,0.723,-103476017.881110,0.105,-332.287,37.8,11.034,08019704,44,12,21187967.887,0.138,-113420857.259284,0.010,2692.320,41.3,625.367,08119f24,44,12,21187978.670,0.021,-88216272.411291,0.014,2094.028,42.1,625.367,00b13f2b,59,4,21449691.447,0.162,-114499914.223487,0.010,3474.231,40.0,1645.190,18119f44,59,4,21449701.207,0.022,-89055534.540751,0.013,2702.181,41.7,1645.190,10b13f4b,58,11,19250390.550,0.099,-103012753.347461,0.009,-688.210,44.2,10917.439,08119fc4,58,11,19250399.220,0.016,-80121074.759157,0.012,-535.276,44.3,10812.119,00b13fcb,42,8,22459067.339,0.170,-120056566.825182,0.011,-3660.647,39.6,1540.058,18119c04,42,8,22459077.683,0.027,-93377366.346772,0.019,-2847.175,39.9,1540.058,00b13c0b*2260ce45",

]
epochs: list[GNSSEpoch] = [deserialize_rangea(r) for r in rangea]
test_epoch = epochs[0]

assert isinstance(test_epoch, GNSSEpoch)
assert len(test_epoch.satellites) == 15

with tempfile.TemporaryDirectory() as tmpdir:
    gnss_obs_array = TDBGNSSObsArray(Path(tmpdir) / "test.tdb")
    gnss_obs_array.write_epochs(epochs)
    
    # Test tile2rinex function
    settings_path = Path(tmpdir) / "rinex_settings.json"
    with open(settings_path, "w") as f:
        json.dump(fake_rinex_settings, f)
    rinex_files = tile2rinex(
        gnss_obs_tdb=gnss_obs_array.uri,
        settings=settings_path,
        writedir=Path(tmpdir),
        time_interval=1,
        processing_year=0,
        modulo_millis=0,
    )
    assert len(rinex_files) > 0
    for rinex_file in rinex_files:
        assert rinex_file.exists()
